#!/bin/bash
#
# install dependencies and configure system for MacOS
#

function die() {
    echo "Fatal: $1"
    exit 1
}

# must have LJHOME
[ -n "$LJHOME" ] || die "You must set the LJHOME environment variable."

# update brew packages
brew ls >/dev/null || die "You must install Mac Homebrew first."
while IFS= read -r package; do
    brew install "$package" || die "Failed to install $package"
done < doc/dependencies-brew

# set flags for compilation and pathing
export PATH="$LJHOME/extlib/bin:$(brew --prefix)/bin:$PATH"
export LIBRARY_PATH="$(brew --prefix)/lib:$(brew --prefix imagemagick)/lib:$LIBRARY_PATH"
export CPATH="$(brew --prefix)/include:$(brew --prefix imagemagick)/include/ImageMagick-7:$CPATH"
export PERL5LIB="$LJHOME/extlib/lib/perl5"

# Install DBD::mysql which doesn't install cleanly using cpanm/cpm, due to
# library shenanigans
cpanm -n -L $LJHOME/extlib \
	--configure-args="--libs=\"-L$(brew --prefix mysql-client@8.4)/lib \
	                  -L$(brew --prefix)/lib \
			  -lmysqlclient -lz  -lzstd  -lssl  -lcrypto -lresolv\"" \
	DBD::mysql

# install cpm with cpanminus
cpanm -n -L $LJHOME/extlib App::cpm || die "Failed to install cpm"

# helper for invocation of cpm to set the right paths
export cpm="perl -I $LJHOME/extlib/lib/perl5 $LJHOME/extlib/bin/cpm"

# doing this would require us also building Perl, not sure if it's worth it?
# export CC="$(brew --prefix)/bin/gcc-14"
# export PERL_MM_OPT="CC=$CC"

# install cpan dependencies
required_modules=()
optional_modules=()

while IFS= read -r module; do
    # if module ends with a ?, it's optional
    if [[ "$module" == *'?' ]]; then
        module="${module%\?}"
        optional_modules+=("$module")
    else
        required_modules+=("$module")
    fi
done < doc/dependencies-cpanm

# install required modules
echo -e "\nInstalling required modules..."
$cpm install --no-test -L $LJHOME/extlib "${required_modules[@]}" || \
    die "Failed to install required modules"

# install optional modules
if [ ${#optional_modules[@]} -ne 0 ]; then
    echo -e "\nInstalling optional modules..."
    $cpm install --no-test -L $LJHOME/extlib "${optional_modules[@]}" || \
        echo "Failed to install optional modules (this is OK)"
fi

# these are modules that we only install on Mac; TODO: it'd be nice to
# have a way to specify this in the dependencies file
$cpm install --no-test -L $LJHOME/extlib Image::Magick
